<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .flipButton {
            width: 470px;
            height: 50px;
        }

        #temperature {
            padding: 5px;
            width: 470px;
            font-size: 1.8em;
            text-align: center;
        }
    </style>
    <script>
    var warn_audio = new Audio('warningSFX.mp3');
    let startX = 0;
    let moveX = 10;
    let startY = 0;
    let moveY = 10;
    const positive = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
    const negative = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'];
    
    function heatMapColorforValue(value, avgLowTemp, avgHighTemp) {
        let h;
        let l = 50;
        let s;
        let a = 1;
        let threshold = 38;
        let diff = avgHighTemp - avgLowTemp;
        if (diff < 4) {
            if (avgHighTemp < 75) {
                threshold = 100 - (diff * 4);
            } else if(avgHighTemp > 75) {
                threshold = (diff * 4);
            }
        }
        if (value < threshold) {//35) {
            h = 200 + (1.0 - (value / threshold)) * 30;
            l = 50 + (value / threshold) * 30;
            s = 60 + (value / threshold) * 35;
            a = 0.8;
        } else {
            h = 10 + 40 * (1.0 - ((value - threshold) / threshold));
            l = 40 + 50 * (1.0 - ((value - threshold) / threshold));//50 * (1.0 - ((value - threshold) / threshold)) + 50;
            s = 98;
            a = 0.95;
        }
        return `hsla( ${h}, ${s}%, ${l}%, ${a})`;
    }

    function percentToRGB(percent) {
        if (percent === 100) {
            percent = 99
        }
        var r, g, b;
        var result = '';
        if (percent < 50) {
            // blue to yellow
            r = Math.floor(255 * ((percent - 30) / 20));//Math.floor(255 * ((50 - percent % 50) / 100));
            g = Math.floor(180 * ((percent) / 50));//Math.floor(80 * ((65 - percent) / 50));;//Math.floor(200 * (percent / 50) - 50);//Math.floor(255 * (percent / 100));//Math.floor(255 * (percent / 50));;
            b = Math.floor(255 * ((75 - percent) / 50));
            result = 'rgba(' + r + ',' + g + ',' + b + ', 0.9)';
        } else {
            // yellow to red
            r = 255;
            g = Math.floor(200 * ((50 - percent % 50) / 50));
            b = Math.floor(100 * ((50 - percent % 50) / 50));//0;
            result = 'rgba(' + r + ',' + g + ',' + b + ', 0.9)';
        }
        return result;
    }

    function ConvertNumber(number, format){
      var tail=format.lastIndexOf('.');number=number.toString();
      tail=tail>-1?format.substr(tail):'';
      if(tail.length>0){if(tail.charAt(1)=='#'){
          tail=number.substr(number.lastIndexOf('.'),tail.length);
      }}
      number=number.replace(/\..*|[^0-9]/g,'').split('');
      format=format.replace(/\..*/g,'').split('');
      for(var i=format.length-1;i>-1;i--){
          if(format[i]=='#'){format[i]=number.pop()}
      }
      return number.join('')+format.join('')+tail;
    }

    // Examples
    // ConvertNumber(1234,'#,###') === 1,234
    // ConvertNumber(1234,'#,###.00') === 1,234.00
    // ConvertNumber(1234,',###.00') === 1,234.00
    // ConvertNumber(1234.4575,',###.##') === 1,234.45
    // ConvertNumber(1234567890.4575,',###,###,###.##') === 1,234,567,890.45
    // ConvertNumber(123.4575,',#,#.##') === 1,2,3.45
    // ConvertNumber(123456.4575,'-#-#.##') === 1234-5-6.45
    // ConvertNumber(1234567.4575,' ## ###.##') === 12 34 567.45
    function interpolateData(input, rowLength) {
        const output = [];
        let rowNum = 1;
        for (let n = 0; n < input.length; n += 1) {
            //output.push(n % rowLength);
            if (n % rowLength === 0) {
                output.push((input[n] + input[n + 1]) / 2)            
            } else if (n > 0) {
                output.push((input[n] + input[n - 1]) / 2)
            } else {
                output.push(input[n]);
            }
            
            if ((n + 1) % rowLength === 0) {
                if (input.length - n > rowLength) {
                    for (let r = 1; r <= rowLength * 2 - 1; r++) {
                        const roundedA = ((rowNum - 1) * rowLength) + Math.floor((r - 1) / 2);
                        const roundedB = ((rowNum - 1) * rowLength) + Math.floor((r - 1) / 2);
                        const topA = input[roundedA];
                        const topB = input[roundedB];
                        const roundedC = (rowNum * rowLength) + Math.floor((r - 1) / 2);
                        const roundedD = (rowNum * rowLength) + Math.floor((r - 1) / 2);
                        const bottomA = input[roundedC];
                        const bottomB = input[roundedD];
                        //output.push(0);
                        output.push((topA + topB + bottomA + bottomB) / 4);
                    }
                    rowNum += 1;
                }
                // Do nothing
            } else {
                //output.push(0);
                output.push((input[n] + input[n + 1]) / 2)
            }
        }
        return output;
    }


    let avgHighTemp = 0;
    let avgLowTemp = 0;
    let highTarget = -100;
    let lowTarget = 200;
    let high = -100;
    let low = 200;
    let frame_counter = 0;
    let connection=undefined;
    let warnFrame=undefined;
    // Log messages from the server
    let onmessage = function (e) {
        if (e.data.length < 100) {
            return;
        }
        frame_counter += 1;
        const values_raw = new Int16Array(e.data);

        const values=values_raw.map(v=>((v/100.0)*36.5/30));
        const tempValues = interpolateData(values, 32);
        const sortedValues = values.slice().sort();
        avgHighTemp = 0;
        
        let avgTemp = sortedValues.reduce((s,v)=>s+v,0)/sortedValues.length;
        for (let w = sortedValues.length - 3; w > sortedValues.length - 10; w -= 1) {
            avgHighTemp += sortedValues[w];
        }
        avgHighTemp = avgHighTemp / 7;

        avgLowTemp = 0;
        for (let w = 4; w < 24; w += 1) {
            avgLowTemp += sortedValues[w];
        }
        avgLowTemp = avgLowTemp / 20;
        if (frame_counter >= 20) {
            let avgHighTempC = avgHighTemp;
            avgHighTempC = parseInt(avgHighTempC * 10) / 10;
            
            let avgTempC = parseInt(avgTemp * 10) / 10;
            let avgLowTempC = avgLowTemp;
            avgLowTempC = parseInt(avgLowTempC * 10) / 10;
            document.getElementById('temperature').innerText = 'High: ' + avgHighTempC + ' C | Low: ' + avgLowTempC + ' C \n AVG: ' + avgTempC + ' C';
            highTarget = -100;
            lowTarget = 200;
            //console.log(JSON.stringify(tempValues));
            for (let i = 0; i < values.length; i += 1) {
                if (values[i] < 120 && values[i] > highTarget) {
                    highTarget = parseInt(values[i]);
                }
                if (values[i] < lowTarget) {
                    lowTarget = parseInt(values[i]);
                }
            }
            if (highTarget - lowTarget < 10) {
                highTarget += 5;
            }
            // high += 2;
            lowTarget += 1;
            // counter = 0;
            // return;
        }
        // if (Math.abs(low - avgLowTemp) < 1.5) {
        //     // do nothing
        // } else if (low === 200) {
        //     low = avgLowTemp;
        // } else if (low > avgLowTemp) {
        //     low -= 1;
        // } else if (low < avgLowTemp) {
        //     low += 1;
        // }
        // if (Math.abs(high - avgHighTemp) < 1.5) {
        //     // do nothing
        // } else if (high === -100) {
        //     high = avgHighTemp;
        // } else if (high > avgHighTemp) {
        //     high -= 1;
        // } else if (high < avgHighTemp) {
        //     high += 1;
        // }

        high=40;
        low=25;

        var c2 = document.getElementById('myCanvas');
        var c2_context = c2.getContext('2d');
        let xPos = startX;
        let yPos = startY;
        for (let i = 0; i < tempValues.length; i += 1) {

            let value = ((tempValues[i] - low) / (high - low)) * 100;
            let drawStroke=false;
            if(tempValues[i]>37.5)
            {
              
              if(warnFrame===undefined)
              {
                warnFrame=frame_counter;
                warn_audio.play();
              }
              c2_context.strokeStyle = "#00FFFF";
              drawStroke=true;
            }
            else
            {
              if(warnFrame!==undefined)
              {
                if(frame_counter-warnFrame>40)
                {
                  warnFrame=undefined;
                  warn_audio.pause();
                }
              }
            }
            c2_context.fillStyle = heatMapColorforValue(value, low, high);
            c2_context.fillRect(yPos, xPos, 10, 10);
            if(drawStroke)
              c2_context.strokeRect(yPos, xPos, 10, 10);
            yPos += moveY;
            if (i > 0 && (i + 1) % 63 === 0) {
                xPos += moveX;
                yPos = startY;
            }
        }
    };
    function ws_start()
    {
      if(connection!==undefined)
      {
        ws_stop();
      }
      let input_IP_DOM=document.getElementById('input_IP');
      let start_btn_DOM=document.getElementById('start_btn');
      input_IP_DOM.disabled=true;
      start_btn_DOM.disabled=true;
      let url = 'ws://'+input_IP_DOM.value;

      connection= new WebSocket(url);

      connection.binaryType = "arraybuffer";
      connection.onopen = function () {
        connection.send('Ping'); // Send the message 'Ping' to the server
      };
      connection.onclose = function(event) {
        input_IP_DOM.disabled=
        start_btn_DOM.disabled=false;
        connection=undefined;
      };
      // Log errors
      connection.onerror = function (error) {
        console.log('WebSocket Error ' + error);
        input_IP_DOM.disabled=
        start_btn_DOM.disabled=false;
        connection=undefined;
      };
      connection.onmessage=onmessage;
    }
    function ws_stop()
    {
      
      if(connection==undefined)
      {
        return;
      }
      connection.close();
    }

    function flipY() {
        if (startY === 0) {
          moveY = -10;
          startY = 630+moveY;
        } else {
          startY = 0;
          moveY = 10;
        }
    }
    function flipX() {
        if (startX === 0) {
            startX = 460;
            moveX = -10;
        } else {
            startX = 0;
            moveX = 10;
        }
    }
    </script>
</head>
<body>
    <canvas id='myCanvas' height='470' width='630' style='border:1px solid #d3d3d3;'></canvas>
    <p id='temperature'></p>
    <button onclick='flipX()'>Flip X</button>
    <button onclick='flipY()'>Flip Y</button>
    <br/>
    <input type="text" id="input_IP" name="input_IP" value="thermal.local:81">
    <button onclick='ws_start()'  id="start_btn">start</button>
    <button onclick='ws_stop()'  id="start_btn">STOP</button>
</body>
</html>